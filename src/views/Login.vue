<template>
  <div>
    <spinner v-if="loading"></spinner>
    <div class="my-auto">
      <h1 class="mx-auto mb-10 text-4xl text-center text-primary">
        SAI Evo &mdash; ver. &alpha; 1.0
      </h1>
      <!-- <button @click="printDebug()">debug</button>
    <button @click="testGetUser()">test get user</button> -->
      <div
        class="w-full px-6 py-12 mx-auto my-auto text-center rounded-md  shadow-elevation-2 md:px-20 md:mx-auto md:w-2/3 border-gray-150"
      >
        <h1 class="mx-auto text-center">
          {{ $t("headings.login") }}
        </h1>
        <p class="mb-3">
          {{ $t("login_screen.login_text") }}
          <strong
            >@{{
              $route.params.role == "teacher" ? "" : "studenti."
            }}unipi.it</strong
          >.
        </p>
        <p class="mb-3">
          <strong> {{ $t("login_screen.warning") }}:</strong>
          {{ $t("login_screen.cookies_warning") }}
        </p>
        <!-- <div class="mb-4">
        <span class="mr-3 font-medium">Browser supportati:</span>
        <img
          class="inline-block w-5 h-5 my-auto mr-2 drop-shadow"
          src="../assets/chrome.png"
        />
        <img
          class="inline-block w-5 h-5 my-auto drop-shadow"
          src="../assets/firefox.png"
        />
      </div> -->
        <div class="mt-12 text-center">
          <Btn
            @click="handleClickSignIn"
            :variant="'success'"
            :size="'lg'"
            class="relative md:w-max"
            :disabled="!googleOauthReady || localLoading"
            :loading="!googleOauthReady && !googleOauthHadError"
          >
            <span class="mr-3 material-icons-outlined">login</span>
            {{ $t("login_screen.login") }}
          </Btn>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
/* eslint-disable */
import Btn from "@/components/ui/Btn.vue";
import { inject, toRefs } from "vue";
//import { getMainView } from '@/router'
import Spinner from "@/components/ui/Spinner.vue";
import { defineComponent } from "@vue/runtime-core";
import { loadingMixin } from "@/mixins";

export default defineComponent({
  name: "Login",
  components: {
    Btn,
    Spinner,
  },
  data() {
    return {
      user: "",
      loadingLogin: true,
    };
  },
  mixins: [loadingMixin],
  methods: {
    redirectToMainView() {
      this.$router.push("/teacher/courses");
    },
    async handleClickSignIn() {
      try {
        this.loading = true;
        const googleUser = await this.$gAuth.signIn();
        console.log(googleUser);
        if (!googleUser) {
          return null;
        }
        this.user = googleUser.getBasicProfile().getEmail();
        const token = googleUser.getAuthResponse().access_token;
        await this.$store.dispatch("shared/convertToken", token);
        await this.$store.dispatch("shared/getUserData");
        this.redirectToMainView();
      } catch (error) {
        // this.$store.commit('pushNotification', {
        //   severity: 2,
        //   autoHide: 9000,
        //   message: 'Si Ã¨ verificato un errore durante il login. Riprova.'
        // })
        throw error;
      } finally {
        this.loading = false;
      }
    },
  },
  setup() {
    const Vue3GoogleOauth = inject("Vue3GoogleOauth");
    return {
      Vue3GoogleOauth,
    };
  },
  created() {
    this.$store.commit("shared/resetToken");
    // if (this.$store.getters.isAuthenticated) {
    //   this.$router.push(getMainView())
    // }
  },
  computed: {
    googleOauthReady() {
      return (this as any).Vue3GoogleOauth.isInit;
    },
    googleOauthHadError() {
      return (this as any).Vue3GoogleOauth.hadError;
    },
  },
});
</script>
